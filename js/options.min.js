$(document).ready(function(){var e=cAstConfig.api.validate();console.log("[调试] 选项页加载，查看数据服务是否正常",e);function t(e){chrome.tts.speak(e,{lang:"zh_CN",rate:1})}function i(){var e=document.getElementsByTagName("html");for(var t=0;t<e.length;t++){var i=e[t];var l=i.innerHTML.toString();var a=l.replace(/__MSG_(\w+)__/g,function(e,t){return t?chrome.i18n.getMessage(t):""});if(a!=l){i.innerHTML=a}}}i();function l(e){var t=e.split("/",3);console.log("[调试] 分割后的数组长度为",t.length);if(null!=t[0].match("http")){return t[2]}if(null!=t[0].match("")){return t[2]}return t[0]}function a(e){e=l(e);if(e[e.length-1]=="/"){console.log("[调试] 返回网站权限字符串为","http://"+e+"*");return"http://"+e+"*"}else{console.log("[调试] 返回网站权限字符串为","http://"+e+"/*");return"http://"+e+"/*"}}function n(e){var t={};t.type="basic";t.iconUrl="images/icon128x128.png";t.title=chrome.i18n.getMessage("extName");t.message=e;t.isClickable=true;chrome.notifications.create("hehe",t,function(e){console.log("[用户通知]发送成功,ID:"+e)})}function r(){var e={};e.type="Config.Update";console.log("[消息] -xx- 发送配置更新消息");chrome.runtime.sendMessage(e,function(e){console.log("[消息] -xx- 接收到更新回复")})}function o(){cAstConfig.api.crawler_rule_query_all(function(e){$("div.crawlerInfo table tbody").html("");if(e==undefined){return}$.each(e,function(e,t){$('<tr><td><input title="选择/不选" type="checkbox" /></td><td>'+e+"</td>"+'<td><a class="crawler_rule_edit_btn" href="/options.html#crawlerEdit?'+t.id+'" data-ruleid='+t.id+">"+t.site_name+"</a></td>"+"<td>"+t.modify_time+"</td><td>"+t.site_url+'</td><td><button class="crawler_rule_delete_btn btn btn-default" data-ruleid='+t.id+">删除</button></td></tr>").appendTo($("div.crawlerInfo table tbody"))});$("a.crawler_rule_edit_btn").click(function(e){var t=$(this).data("ruleid");cAstConfig.api.crawler_rule_query_by_id(t,function(e){console.log("[调试] 要编辑的抓取规则当前对象为",e);$("div.itab").hide();$("div.crawlerDetail").show(function(){$("div.crawlerDetail input#id").val(e.id);$("div.crawlerDetail input#site_url").val(e.site_url);$("div.crawlerDetail input#site_name").val(e.site_name);$("div.crawlerDetail input#url_regex").val(e.url_regex);$("div.crawlerDetail input#title_dom_path").val(e.title_dom_path);$("div.crawlerDetail input#author_dom_path").val(e.author_dom_path);$("div.crawlerDetail input#time_dom_path").val(e.time_dom_path);$("div.crawlerDetail input#content_dom_path").val(e.content_dom_path)})});console.log("[调试] 抓取规则",t,"被点击")});$("button.crawler_rule_delete_btn").click(function(e){var t=$(this).data("ruleid");console.log("[调试] 抓取规则",t,"删除按钮被点击");cAstConfig.api.crawler_rule_delete(t,function(e){o()})});console.log("[调试] 抓取规则载入成功")})}function c(){cAstConfig.api.target_rule_query(function(e){if(undefined==e){return}$("div.targetInfo select#site_type").val(e.site_type);$("div.targetInfo input#site_url").val(e.site_url);$("div.targetInfo input#site_name").val(e.site_name);$("div.targetInfo input#url_new").val(e.url_new);$("div.targetInfo input#title_dom_path").val(e.title_dom_path);$("div.targetInfo input#title_label_dom_path").val(e.title_label_dom_path);$("div.targetInfo input#time_dom_path").val(e.time_dom_path);$("div.targetInfo input#content_dom_path").val(e.content_dom_path);console.log("[调试] 目标规则载入成功")})}function u(e,t){var i=new FileReader;i.onload=function(e){var i=null;if(e.target.readyState){var l=e.target.result;if(null!=l){i=JSON.parse(l)}}else{console.log("[调试] FileReader还没有准备好")}t(i)};i.readAsText(e)}$("a#machineBtn").click(function(e){$("ul.nav li").removeClass("active");$(this).parent("li").addClass("active");$("div.itab").hide();$("div.itab-detail").hide();$("div.machineInfo").show()});$("input#crawler_config_fileinput").click(function(e){$("button#target_config_import_apply_btn").data("config_json_obj",null);$("div#crawler_upload_area span.upload_result_tips").remove()});$("input#target_config_fileinput").click(function(e){$("button#crawler_config_import_apply_btn").data("config_json_obj",null);$("div#target_upload_area span.upload_result_tips").remove()});$("button#crawler_config_import_upload_btn").click(function(e){var t=$("input#crawler_config_fileinput").get(0).files[0];if(t==null){n(chrome.i18n.getMessage("noticeFileNotSelected"));return}u(t,function(e){console.log("[调试] 抓取配置信息为",e);$("button#crawler_config_import_apply_btn").data("config_json_obj",e);$("div#crawler_upload_area").append('<span class="upload_result_tips">'+chrome.i18n.getMessage("infoNextStepApplyBtn")+"</span>")})});$("button#crawler_config_import_apply_btn").click(function(e){var t=$(e.target).data("config_json_obj");for(var i=t.length-1;i>=0;i--){d(f,t[i])}});var s=[];var _=false;function d(e,t){if(t!=null){if(_){s.push(t)}else{_=true;e(t)}}else{config=s.shift();if(config!=null){_=true;e(config)}}}$("button#target_config_import_upload_btn").click(function(e){var t=$("input#target_config_fileinput").get(0).files[0];if(t==null){n(chrome.i18n.getMessage("noticeFileNotSelected"));return}console.log("[调试] 目标配置导入保存按键被点击",e);u(t,function(e){console.log("[调试] 目标配置信息为",e);$("button#target_config_import_apply_btn").data("config_json_obj",e);$("div#target_upload_area").append('<span class="upload_result_tips">'+chrome.i18n.getMessage("infoNextStepApplyBtn")+"</span>")})});$("button#target_config_import_apply_btn").click(function(e){var t=$(e.target).data("config_json_obj");g(t)});$("#crawler_config_import_modal").on("hidden.bs.modal",function(e){var t=e.target;t.querySelector("input").files=null;$(t).find("button#crawler_config_import_apply_btn").data("config_json_obj",null);$(t).find("span.upload_result_tips").remove()});$("#target_config_import_modal").on("hidden.bs.modal",function(e){var t=e.target;t.querySelector("input").files=null;$(t).find("button#target_config_import_apply_btn").data("config_json_obj",null);$(t).find("span.upload_result_tips").remove()});$("button#crawler_config_export_btn").click(function(e){cAstConfig.api.crawler_rule_query_all(function(e){console.log("[调试] 查询到以下抓取规则",e);console.log("[调试] 抓取规则转换为字符串：",JSON.stringify(e));var t=new Blob([JSON.stringify(e)],{type:"text/plain"});var i=window.URL.createObjectURL(t);chrome.downloads.download({url:i,saveAs:true},function(e){console.log("[调试] 已下载",e)})})});$("button#target_config_export_btn").click(function(e){cAstConfig.api.target_rule_query(function(e){var t=new Blob([JSON.stringify(e)],{type:"text/plain"});var i=window.URL.createObjectURL(t);chrome.downloads.download({url:i,saveAs:true},function(e){console.log("[调试] 已下载",e)})})});$("a#crawlerBtn").click(function(e){$("ul.nav li").removeClass("active");$(this).parent("li").addClass("active");$("div.itab").hide();$("div.itab-detail").hide();$("div.crawlerInfo").show(function(){o()})});$("a#targetBtn").click(function(e){$("ul.nav li").removeClass("active");$(this).parent("li").addClass("active");$("div.itab").not("div.targetInfo").hide();$("div.itab-detail").hide();$("div.targetInfo").show(function(){c()})});$("a#helpBtn").click(function(e){$("ul.nav li").removeClass("active");$(this).parent("li").addClass("active");$("div.itab").not("div.helpInfo").hide();$("div.itab-detail").hide();$("div.helpInfo").show()});function f(e){cAstConfig.api.crawler_rule_query_count(function(t){if(t<5){var i=true;var l=false;if(e.url_regex==""||e.site_url==""||e.site_name==""||e.title_dom_path==""||e.author_dom_path==""||e.time_dom_path==""||e.content_dom_path==""){l=false}else{l=true}if(e.id){i=false}else{e.id=(new Date).getTime()}if(l==true){if(i){chrome.permissions.request({permissions:["tabs"],origins:[a(e.url_regex)]},function(t){if(t){console.log("[调试] 用户同意该访问权限");cAstConfig.api.crawler_rule_new(e,function(e){if(e){n(chrome.i18n.getMessage("noticeCrawlRuleAddedSuccess"));r()}else{n(chrome.i18n.getMessage("noticeCrawlRuleAddedFailure"))}_=false;d(f,null)})}else{console.log("[调试] 用户拒绝该访问权限");n(chrome.i18n.getMessage("noticeCrawlRuleAddedFailureAsPermission"));_=false;d(f,null)}})}else{cAstConfig.api.crawler_rule_query_by_url(e.url_regex,function(t){if(null==t){chrome.permissions.request({permissions:["tabs"],origins:[a(e.url_regex)]},function(t){if(t){console.log("[调试] 用户同意该访问权限");cAstConfig.api.crawler_rule_update(e,function(t){if(t){n(chrome.i18n.getMessage("noticeCrawlRuleUpdatedSuccess"));r();_=false;d(f,null)}else{n(chrome.i18n.getMessage("noticeCrawlRuleUpdatedFailure"));cAstConfig.api.crawler_rule_new(e,function(e){if(e){n(chrome.i18n.getMessage("noticeCrawlRuleAddedSuccess"));r()}else{n(chrome.i18n.getMessage("noticeCrawlRuleAddedFailure"))}_=false;d(f,null)})}})}else{console.log("[调试] 用户拒绝该访问权限");n(chrome.i18n.getMessage("noticeCrawlRuleUpdatedFailureAsPermission"));_=false;d(f,null)}})}else{cAstConfig.api.crawler_rule_update(e,function(t){if(t){n(chrome.i18n.getMessage("noticeCrawlRuleUpdatedSuccess"));r();_=false;d(f,null)}else{n(chrome.i18n.getMessage("noticeCrawlRuleUpdatedFailure"));cAstConfig.api.crawler_rule_new(e,function(e){if(e){n(chrome.i18n.getMessage("noticeCrawlRuleAddedSuccess"));r()}else{n(chrome.i18n.getMessage("noticeCrawlRuleAddedFailure"))}_=false;d(f,null)})}})}})}}else{n(chrome.i18n.getMessage("noticeRuleFormatError"));_=false;d(f,null)}}else{n(chrome.i18n.getMessage("noticeCrawlRuleNumberOut"));_=false;d(f,null)}})}$("a#crawler_rule_save_btn").click(function(e){cAstConfig.api.crawler_rule_query_count(function(e){if(e<5){var t=true;var i={};i.url_regex=$("div.crawlerDetail input#url_regex").val();i.title_dom_path=$("div.crawlerDetail input#title_dom_path").val();i.author_dom_path=$("div.crawlerDetail input#author_dom_path").val();i.time_dom_path=$("div.crawlerDetail input#time_dom_path").val();i.content_dom_path=$("div.crawlerDetail input#content_dom_path").val();i.site_url=$("div.crawlerDetail input#site_url").val();i.site_name=$("div.crawlerDetail input#site_name").val();i.modify_time=Date();if(undefined==$("div.crawlerDetail input#id").val()||$("div.crawlerDetail input#id").val()==""){console.log("没有ID");i.id=(new Date).getTime()}else{console.log("[调试] 已经有ID了");t=false;console.log($("div.crawlerDetail input#id").val());i.id=$("div.crawlerDetail input#id").val()}var l=false;if(i.url_regex==""||i.site_url==""||i.site_name==""||i.title_dom_path==""||i.author_dom_path==""||i.time_dom_path==""||i.content_dom_path==""){l=false}else{l=true}if(l==true){if(t){chrome.permissions.request({permissions:["tabs"],origins:[a(i.url_regex)]},function(e){if(e){console.log("[调试] 用户同意该访问权限");cAstConfig.api.crawler_rule_new(i,function(e){if(e){n(chrome.i18n.getMessage("noticeCrawlRuleAddedSuccess"));r()}else{n(chrome.i18n.getMessage("noticeCrawlRuleAddedFailure"))}})}else{console.log("[调试] 用户拒绝该访问权限");n(chrome.i18n.getMessage("noticeCrawlRuleAddedFailureAsPermission"))}})}else{cAstConfig.api.crawler_rule_query_by_url(i.url_regex,function(e){if(null==e){chrome.permissions.request({permissions:["tabs"],origins:[a(i.url_regex)]},function(e){if(e){console.log("[调试] 用户同意该访问权限");cAstConfig.api.crawler_rule_update(i,function(e){if(e){n(chrome.i18n.getMessage("noticeCrawlRuleUpdatedSuccess"));r()}else{n(chrome.i18n.getMessage("noticeCrawlRuleUpdatedFailureDone"))}})}else{console.log("[调试] 用户拒绝该访问权限");n(chrome.i18n.getMessage("noticeCrawlRuleUpdatedFailureAsPermission"))}})}else{cAstConfig.api.crawler_rule_update(i,function(e){if(e){n(chrome.i18n.getMessage("noticeCrawlRuleUpdatedSuccess"));r()}else{n(chrome.i18n.getMessage("noticeCrawlRuleUpdatedFailureDone"))}})}})}}else{n(chrome.i18n.getMessage("noticeRuleFormatError"))}}else{n(chrome.i18n.getMessage("noticeCrawlRuleNumberOut"))}})});$("button#crawler_rule_cancel_btn").click(function(e){$("div.crawlerInfo").show();$("div.crawlerDetail").hide()});$("button#crawler_rule_clear_btn").click(function(e){cAstConfig.api.crawler_rule_clear(function(e){if(e){n(chrome.i18n.getMessage("noticeCrawlRuleClearSuccess"));r()}else{n(chrome.i18n.getMessage("noticeCrawlRuleClearFailure"))}o()})});$("button#crawler_rule_refresh_btn").click(function(e){o()});$("a#crawler_rule_new_btn").click(function(e){cAstConfig.api.crawler_rule_query_count(function(e){if(e<5){$("div.itab").hide();$("div.crawlerDetail").show(function(){$("div.crawlerDetail input#id").val("");$("div.crawlerDetail input#url_regex").val("");$("div.crawlerDetail input#title_dom_path").val("");$("div.crawlerDetail input#author_dom_path").val("");$("div.crawlerDetail input#time_dom_path").val("");$("div.crawlerDetail input#content_dom_path").val("");$("div.crawlerDetail input#site_url").val("");$("div.crawlerDetail input#site_name").val("")})}else{n(chrome.i18n.getMessage("noticeCrawlRuleNumberOut"))}})});function g(e){var t=false;if(e.site_type==""||e.site_url==""||e.site_name==""||e.url_new==""||e.title_dom_path==""||e.title_label_dom_path==""||e.time_dom_path==""||e.content_dom_path==""){t=false}else{t=true}if(t==true){chrome.permissions.request({permissions:["tabs"],origins:[a(e.url_new)]},function(t){if(t){console.log("[调试] 用户同意该访问权限");cAstConfig.api.target_rule_new(e,function(e){if(e){n(chrome.i18n.getMessage("noticeTargetRuleUpdatedSuccess"));r()}else{n(chrome.i18n.getMessage("noticeTargetRuleUpdatedFailure"))}})}else{console.log("[调试] 用户拒绝该访问权限");n(chrome.i18n.getMessage("noticeTargetRuleAddedFailureAsPermission"))}})}else{n(chrome.i18n.getMessage("noticeRuleFormatError"))}}$("a.target_rule_save_btn").click(function(e){var t={};t.site_type=$("div.targetInfo select#site_type").val();t.site_url=$("div.targetInfo input#site_url").val();t.site_name=$("div.targetInfo input#site_name").val();t.url_new=$("div.targetInfo input#url_new").val();t.title_dom_path=$("div.targetInfo input#title_dom_path").val();t.title_label_dom_path=$("div.targetInfo input#title_label_dom_path").val();t.time_dom_path=$("div.targetInfo input#time_dom_path").val();t.content_dom_path=$("div.targetInfo input#content_dom_path").val();t.modify_time=Date();console.log("[调试] 新增目标规则",t);g(t)});chrome.tabs.getCurrent(function p(e){currentUrl=e.url;defaultPage=true;if(currentUrl.match("#crawlerInfo")!=null){defaultPage=false;$("a#crawlerBtn").click()}if(currentUrl.match("#targetInfo")!=null){defaultPage=false;$("a#targetBtn").click()}if(currentUrl.match("#machineInfo")!=null){defaultPage=false;$("a#machineBtn").click()}if(currentUrl.match("#aboutInfo")!=null){defaultPage=false;$("a#aboutBtn").click()}if(defaultPage==true){$("a#machineBtn").click()}})});
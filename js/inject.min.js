console.log("[调试] 目标页已加载inject.js");console.log("[调试] 传递过来的目标模板规则",tgt_rule);var file_upload_button_html=""+"<!-- Button trigger modal -->"+'<button id="file_upload_status_btn" type="button" class="btn btn-primary btn-lg" style="display:none;" data-toggle="modal" data-target="#myModal">'+"Launch demo modal"+"</button>";var file_upload_modal_html=""+'<div class="modal fade"  id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">'+'<div class="modal-dialog">'+'<div class="modal-content">'+'<div class="modal-header">'+'<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+'<h4 class="modal-title">'+chrome.i18n.getMessage("infoUploadImagesPanelTitle")+"</h4>"+"</div>"+'<div class="modal-body">'+'<div><div style="text-align:right"><button class="btn btn-primary btn-sm images_upload_btn">'+chrome.i18n.getMessage("btnUploadBtn")+"</button>&nbsp;"+'<button class="btn btn-warning btn-sm images_replace_local_btn">'+chrome.i18n.getMessage("btnReplaceBtn")+"</button></div>"+'<ul><li class="divider"></li></ul>'+'<div id="progress_group"></div>'+"</div>"+'<div id="upload_debug_info"><input id="img_select_all_or_not" type="checkbox">'+chrome.i18n.getMessage("infoSelectNotAll")+"</input></div>"+"</div>"+'<div class="modal-footer">'+'<button type="button" class="btn btn-default" data-dismiss="modal">'+chrome.i18n.getMessage("btnCloseBtn")+"</button>"+"</div>"+"</div><!-- /.modal-content -->"+"</div><!-- /.modal-dialog -->"+"</div><!-- /.modal -->";$("body").append(file_upload_button_html);$("body").append(file_upload_modal_html);var upload_image_panel_status=false;$("#myModal").on("show.bs.modal",function(e){upload_image_panel_status=true});$("#myModal").on("hide.bs.modal",function(e){upload_image_panel_status=false});$("input#img_select_all_or_not").change(function(e){console.log(this.checked);if(this.checked){var t=document.querySelectorAll("input.single_checkbox");for(var a=t.length-1;a>=0;a--){t[a].checked=true}}else{var t=document.querySelectorAll("input.single_checkbox");for(var a=t.length-1;a>=0;a--){t[a].checked=false}}});function send_image_req_msg(e){var t={};t.type="Crawl.ImagesReq";t.data=e;console.log("[消息]","-x1-","target发出抓取图片请求");chrome.runtime.sendMessage(t,function(e){console.log("[消息]","-x4-","target接收到确认消息",e)})}$("button.images_upload_btn").click(function(e){var t=$("input.single_checkbox:checked").siblings("div").find("img");console.log("[调试] 共选择以下图片需要转存本地",t.toArray());var a=[];t.each(function(e,t){a.push(t.src)});send_image_req_msg(a)});function convertURLToRegExp(e){return e.replace(/\./g,"\\.")}$("button.images_replace_local_btn").click(function(e){console.log("[调试] 替换为本网站的图片地址");var t=get_current_content();console.log("[调试] 替换前",t);$("div#myModal img").each(function(e,a){if($(a).data("imgstatus")=="remote"){var o=$(a).data("local_url");var n=$(a).data("origin_url");if(o!=null){$(a).attr("src",o);$(a).data("imgstatus","local");var l=convertURLToRegExp(n);console.log("[调试] img src正则表达式转义后的exp为",l);var i=new RegExp(l,"g");t=t.replace(i,o);console.log("[调试] 正文中匹配img src的字符串为",t.match(i))}}});set_content(t)});function get_image_list(e){console.log("[调试] -----------------------------开始搜索图片-------------------------------");var t=[];$(e).find("img").each(function(e,a){console.log(a.src);t.push(a.src)});return t;console.log("[调试] -----------------------------结束搜索图片-------------------------------")}function display_image_list(e){var t='<style type="text/css">'+"#upload_debug_info ul {"+"padding-left: 0;"+"list-style: none;}"+"#upload_debug_info li {"+"width: 25%;"+"font-size: 12px;"+"float: left;"+"height: 115px;"+"padding: 10px;"+"line-height: 1.4;"+"text-align: center;"+"background-color: #f9f9f9;"+"border: 1px solid #fff;}"+"#upload_debug_info li div {"+"width:100%;height:90px;border:solid gray 1px;overflow:hidden; margin-bottom:5px;padding:2px;}"+"#upload_debug_info li img"+"{width:100%;"+""+"}"+"</style>";$("head").append(t);var a=document.createElement("ul");$.each(e,function(e,t){var o=document.createElement("li");var n=document.createElement("div");var l=document.createElement("img");var i=document.createElement("input");l.src=t;i.type="checkbox";i.className="single_checkbox";n.appendChild(l);o.appendChild(n);o.appendChild(i);a.appendChild(o)});$("div#upload_debug_info").append(a)}function testdoc(){console.log($(document))}testdoc();function get_wpnonce(){console.log("[调试] -----------------------------开始搜索脚本，查找_wpnonce-----------------------------");var e=null;$("script").each(function(t,a){var o=a.innerHTML.match(/"_wpnonce":"\S+?"/);if(null!=o){var n=o[0];var l=n.split(":",2);e=l[1].replace(/\"/g,"");console.log("[调试] 已发现_wpnonce",e)}});console.log("-----------------------------结束搜索脚本，查找_wpnonce-----------------------------");return e}var _wpnonce_searched=get_wpnonce();function get_post_id(){console.log("[调试] -----------------------------开始搜索脚本，查找_post_id-----------------------------");var e=null;$("script").each(function(t,a){var o=a.innerHTML;var n=/_wpMediaViewsL10n.*?"post".*?"id":(\d+?),.*?};/;var l=n.exec(o);if(null!=l){e=l[1];console.log("[调试] 已发现_post_id",e)}});console.log("-----------------------------结束搜索脚本，查找_post_id-----------------------------");return e}var _post_id=get_post_id();function monitor_upload_process(e){if(e.lengthComputable){console.log("[XHR监测] "+e.target.xoriginurl+"/"+e.target.xtag+"上传了",e.loaded,"/",e.total);var t=100*e.loaded/e.total;$("div#"+e.target.xtag+"").find("div.progress-bar").attr("aria-valuenow",""+t+"").css("width",t+"%").html(t+"%")}else{console.log("[XHR调试] 无法获取源文件大小")}}function transfer_complete(e){console.log("[XHR调试] 上传完成");if(JSON.parse(e.target.response).success){var t=e.target.xoriginurl;$img_node=$('div#myModal img[src="'+t+'"]').data("origin_url",t).data("local_url",JSON.parse(e.target.response).data.url).data("imgstatus","remote");$img_div=$img_node.parent("div");$img_div.siblings("input").remove();$img_div.after('<span class="upload_tips">'+chrome.i18n.getMessage("infoUploadComplete")+"</span>")}}function transfer_error(e){console.log("[XHR调试] 上传失败");var t=e.target.xoriginurl;$img_node=$('img[src="'+t+'"]');$img_div=$img_node.parent("div");$img_div.siblings("input").after('<span class="upload_tips">'+chrome.i18n.getMessage("infoUploadFailure")+"</span>")}function transfer_abort(e){console.log("[XHR调试] 上传被用户中止")}function dataurl_to_Blob(e){console.log("imagedata 长度为",e.imagedata.length);var t=atob(e.imagedata);var a=new ArrayBuffer(t.length);var o=new Uint8Array(a);for(var n=0;n<t.length;n++){o[n]=t.charCodeAt(n)}console.log("ia 长度为",o.size,o);var l=new Blob([o],{type:e.imagetype});return l}function dataURLtoBlob(e){var t=atob(e.split(",")[1]),a=e.split(",")[0].split(":")[1].split(";")[0];var o=new ArrayBuffer(t.length);var n=new Uint8Array(o);for(var l=0;l<t.length;l++){n[l]=t.charCodeAt(l)}var i=new Blob([n],{type:a});return i}function uuid(){var e=[];var t="0123456789abcdef";for(var a=0;a<36;a++){e[a]=t.substr(Math.floor(Math.random()*16),1)}e[14]="4";e[19]=t.substr(e[19]&3|8,1);e[8]=e[13]=e[18]=e[23]="-";var o=e.join("");return o}function get_upload_img_url(e){console.log("[debug] heh ",e);var t=e;var a=t.match(/.+\//g);return a+"async-upload.php"}function upload_file(e){console.log("[调试] 要上传的文件为",e);var t=dataurl_to_Blob(e);console.log("[调试] 转换为Blob为",t);var a=new FormData;var o="",n="upload-attachment",l=_post_id,i=_wpnonce_searched;if(i==null){console.log("[调试] 未获得授权，找不到_wpnonce");return}var r=uuid();var s=r+"."+e.imagetype.split("/")[1];a.append("name",o);a.append("action",n);a.append("post_id",l);a.append("_wpnonce",i);a.append("async-upload",t,s);var d=new XMLHttpRequest,c="POST",g=get_upload_img_url(window.location.href),u=true,p="",_="";d.open(c,g,u);d.onreadystatechange=function(e){if(d.readyState==XMLHttpRequest.DONE){var t=JSON.parse(d.responseText);if(false==t.success){console.log("[调试] "+t.data.filename+"上传失败：",t.data.message);var a=e.target.xoriginurl;$img_node=$('img[src="'+a+'"]');$img_div=$img_node.parent("div");var o='<a  class="upload_tips" href="javascript:void(0)" role="button" data-toggle="popover" '+'title="'+chrome.i18n.getMessage("infoUploadFailure")+'" data-content="'+""+t.data.message+'">'+chrome.i18n.getMessage("infoUploadFailure")+"</a>";$img_div.siblings(".upload_tips").remove();$img_div.siblings("input").after(o);$('[data-toggle="popover"]').popover()}}};d.addEventListener("progress",monitor_upload_process);d.addEventListener("load",transfer_complete);d.addEventListener("error",transfer_error);d.addEventListener("abort",transfer_abort);d.xtag=r;d.xoriginurl=e.imageoriginurl;var m=""+"<div "+'id="'+r+'"'+">"+"<span>"+s+chrome.i18n.getMessage("infoUploadProgress")+"</span>"+'<div class="progress">'+'<div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="min-width: 2em; width:0%">'+"0% </div>"+"</div>"+"</div>";$("div#progress_group").append(m);d.send(a)}function set_title(e){$(tgt_rule.title).val(e);$(tgt_rule.title).change();$(tgt_rule.title).click();$(tgt_rule.label).click()}function set_content(e){$(tgt_rule.content).html(e);$(tgt_rule.content).focus();$(tgt_rule.content).change();$(tgt_rule.content).click();console.log($("div.mce-container"));if($("div.mce-container").length>0){$("div#wp-content-editor-container iframe#content_ifr").get(0).contentDocument.getElementById("tinymce").innerHTML=e}}function get_current_content(){var e=null;if($("div.mce-container").length>0){e=$("iframe#content_ifr").get(0).contentDocument.getElementById("tinymce").innerHTML}if(null==e){e=$(tgt_rule.content).val()}return e}chrome.runtime.onMessage.addListener(function(e,t,a){if(e.type=="Crawl.Result"){console.log("[消息]","-11-","target接收到注入请求的消息",e);set_title(e.data.title);set_content(e.data.content);var o=get_image_list(e.data.content);display_image_list(o);$("button#file_upload_status_btn").click()}if(e.type=="Crawl.ImagesResult"){console.log("[消息]","-x11-","接收到图片下载完成的消息",e);upload_file(e.data)}if(e.type=="Target.ImagesPanelOpen"){console.log("[消息]","-x11-","接收到查看图片上传状态面板的消息",e);if(upload_image_panel_status==false){$("button#file_upload_status_btn").click()}}var n={};n.type="Msg.Confirm";a(n);console.log("[消息]","-12-","target回复确认消息",n)});var crawler_msg_req={};crawler_msg_req.type="Crawl.Req";console.log("[消息]","-1-","target发出抓取请求");chrome.runtime.sendMessage(crawler_msg_req,function(e){console.log("[消息]","-4-","target接收到确认消息",e)});
var target_rule={url_new:"http://dev.cloudxinhua.com:8022/wordpress/wp-admin/post-new.php"};var crawler_rule=[{url_regex:/http:\/\/www.cnblogs.com\/\S+\/p\/\d+\.html/g}];console.log("[调试] 原字符串为",crawler_rule[0].url_regex);var tab_crawler;function notification_user(e){var t={};t.type="basic";t.iconUrl="images/icon128x128.png";t.title=chrome.i18n.getMessage("extName");t.message=e;t.isClickable=true;chrome.notifications.create("hehe",t,function(e){console.log("[用户通知]发送成功,ID:"+e)})}function google_format_to_regex(e){var t=e.replace(/\*/g,"\\S*");t=t.replace(/\./g,"\\.");t=t.replace(/\//g,"\\/");console.log("[调试] 转换后的字符串为",t);return t}function config_reload(){cAstConfig.api.crawler_rule_query_all(function(e){crawler_rule=e;if(null==crawler_rule){notification_user(chrome.i18n.getMessage("noticeCrawlRuleNotFound"))}else{for(var t=crawler_rule.length-1;t>=0;t--){crawler_rule[t].url_regex=google_format_to_regex(crawler_rule[t].url_regex)}}});cAstConfig.api.target_rule_query(function(e){target_rule=e;if(null==target_rule){notification_user(chrome.i18n.getMessage("noticeTargetRuleNotFound"))}})}config_reload();function shareto(e,t){console.log("[事件] ",t,"上的转载按钮被点击!");if(t.status!="complete"){notification_user(chrome.i18n.getMessage("noticeSourcePageNotLoaded"));return}var o=false;for(var n=crawler_rule.length-1;n>=0;n--){if(t.url.match(crawler_rule[n].url_regex)){o=true}}if(!o){notification_user(chrome.i18n.getMessage("noticeCrawlRuleNotFound"));return}tab_crawler=null;if(null!=target_rule&&null!=target_rule.url_new){console.log("[调试] tab_crawler状态",t);tab_crawler=t;chrome.tabs.create({url:target_rule.url_new+"#fromassistent",active:true},function(e){console.log("[调试] 打开转载目标页",e)})}else{notification_user(chrome.i18n.getMessage("noticeTargetRuleNotFound"))}}function check_photo_upload_panel(e,t){console.log("[事件] ",t,"上的查看图片上传状态按钮被点击");if(t.status!="complete"){notification_user(chrome.i18n.getMessage("noticeSourcePageNotLoaded"));return}var o={};o.type="Target.ImagesPanelOpen";chrome.tabs.sendMessage(t.id,o,null,function(e){console.log("[消息]","-x13-","background接收到",t.id,"回复的注入信息结果",e)})}function enable_dom_element_operator_btn(){chrome.contextMenus.update("btn.rightclick.set_element_dom_path_panel.open",{enabled:true});chrome.contextMenus.update("btn.rightclick.set_element_dom_path_panel.copydompath",{enabled:true});chrome.contextMenus.update("btn.rightclick.set_element_dom_path_panel.copyelement",{enabled:true});chrome.contextMenus.update("btn.rightclick.set_element_dom_path_panel.copytext",{enabled:true})}function disable_dom_element_operator_btn(){chrome.contextMenus.update("btn.rightclick.set_element_dom_path_panel.open",{enabled:false});chrome.contextMenus.update("btn.rightclick.set_element_dom_path_panel.copydompath",{enabled:false});chrome.contextMenus.update("btn.rightclick.set_element_dom_path_panel.copyelement",{enabled:false});chrome.contextMenus.update("btn.rightclick.set_element_dom_path_panel.copytext",{enabled:false})}function enable_set_element_dom_path_panel(e,t){console.log("[事件] ",t,"上的开启/关闭设置DOM规则按钮被点击",e);if(t.status!="complete"){notification_user(chrome.i18n.getMessage("noticeSourcePageNotLoaded"));return}var o={};if(e.checked==true){o.type="Crawler.DomSelectorEnabled";enable_dom_element_operator_btn();chrome.tabs.sendMessage(t.id,o,null,function(e){console.log("[消息]","-x13-","background接收到",t.id,"回复的注入信息结果",e)})}else{o.type="Crawler.DomSelectorDisabled";disable_dom_element_operator_btn();chrome.tabs.sendMessage(t.id,o,null,function(e){console.log("[消息]","-x13-","background接收到",t.id,"回复的注入信息结果",e)})}}function open_set_element_dom_path_panel(e,t){console.log("[事件] ",t,"上的打开设置对话框按钮被点击",e);if(t.status!="complete"){notification_user(chrome.i18n.getMessage("noticeSourcePageNotLoaded"));return}var o={};o.type="Crawler.RuleSetPanelOpen";chrome.tabs.sendMessage(t.id,o,null,function(e){console.log("[消息]","-x13-","background接收到",t.id,"回复的注入信息结果",e)})}function copydompath_this_element_select(e,t){console.log("[事件] ",t,"上的复制DOM路径按钮被点击",e);if(t.status!="complete"){notification_user(chrome.i18n.getMessage("noticeSourcePageNotLoaded"));return}var o={};o.type="Crawler.CopyDOMPathBtnClicked";chrome.tabs.sendMessage(t.id,o,null,function(e){console.log("[消息]","-x13-","background接收到",t.id,"回复的注入信息结果",e)})}function copyelement_this_element_select(e,t){console.log("[事件] ",t,"上的复制Element按钮被点击",e);if(t.status!="complete"){notification_user(chrome.i18n.getMessage("noticeSourcePageNotLoaded"));return}var o={};o.type="Crawler.CopyElementBtnClicked";chrome.tabs.sendMessage(t.id,o,null,function(e){console.log("[消息]","-x13-","background接收到",t.id,"回复的注入信息结果",e)})}function copytext_this_element_select(e,t){console.log("[事件] ",t,"上的复制文本按钮被点击",e);if(t.status!="complete"){notification_user(chrome.i18n.getMessage("noticeSourcePageNotLoaded"));return}var o={};o.type="Crawler.CopyTextBtnClicked";chrome.tabs.sendMessage(t.id,o,null,function(e){console.log("[消息]","-x13-","background接收到",t.id,"回复的注入信息结果",e)})}function view_this_crawler_rule(e,t){console.log("[事件] ",t,"上的查看当前网站抓取规则按钮被点击",e);if(t.status!="complete"){notification_user(chrome.i18n.getMessage("noticeSourcePageNotLoaded"));return}var o={};o.type="Crawler.ViewThisCrawlerRule";chrome.tabs.sendMessage(t.id,o,null,function(e){console.log("[消息]","-x13-","background接收到",t.id,"回复的注入信息结果",e)})}contexts_shareto=["page","selection","image","video","audio"];btnid1=chrome.contextMenus.create({id:"btn.rightclick.pagecapture",title:chrome.i18n.getMessage("extShareBtnTitle"),contexts:contexts_shareto,onclick:shareto});btnid2=chrome.contextMenus.create({id:"btn.rightclick.check_photo_upload_panel",title:chrome.i18n.getMessage("extCheckImagesBtnTitle"),contexts:contexts_shareto,onclick:check_photo_upload_panel});function blob_to_DataURL(e,t){var o=new FileReader;o.onload=function(e){var o=null;if(e.target.readyState){var o=e.target.result;if(null!=o){var n=o.split(",",2);o=n[1]}}else{console.log("[调试] FileReader还没有准备好")}t(o)};o.readAsDataURL(e)}function get_img_file(e,t){var o=new XMLHttpRequest,n="GET",r=true,l="",a="";o.open(n,e,r);o.onreadystatechange=function(n){if(o.readyState==XMLHttpRequest.DONE){if(o.status==200){console.log("[调试] 下载完图片，大小为",o.response.size,"开始上传");blob_to_DataURL(o.response,function(n){var r={};r.imagedata=n;r.imagetype=o.response.type;r.imageoriginurl=e;var l={};l.type="Crawl.ImagesResult";l.data=r;console.log("[消息]","-x8-","crawler向runtime回复图片抓取信息",l);chrome.tabs.sendMessage(t,l,null,function(e){console.log("[消息]","-x13-","background接收到",t,"回复的注入信息结果",e)})})}}};o.responseType="blob";o.send()}function get_site_domainname_from_url(e){var t=e.split("//",2);var o=t[0];o=o.replace(":","");var n=t[1];var r=n.split("/");var l=r[0];return o+"://"+l}chrome.runtime.onMessage.addListener(function(e,t,o){console.log("[消息]","-2-","background接收到",t,"发来消息",e.type);var n={};n.type="Msg.Confirm";o(n);console.log("[消息]","-3-","background回复确认消息",n.type);if(e.type=="Crawl.Req"){console.log("[消息]","-5-","background判断消息类型为",e.type);console.log("[消息]","-6-","background向",tab_crawler,"转发抓取消息",e);chrome.tabs.sendMessage(tab_crawler.id,e,null,function(o){console.log("[消息]","-9-","background接收到",e.type,"类型的消息");console.log("[消息]","-10-","background转发抓取结果，向目标页",t,"发出注入请求",o);chrome.tabs.sendMessage(t.tab.id,o,null,function(e){console.log("[消息]","-13-","background接收到",t.tab,"回复的注入信息结果",e)})})}if(e.type=="Config.Update"){console.log("[消息] -xx- 接收到配置更新的消息");config_reload()}if(e.type=="Crawl.ImagesReq"){console.log("[消息]","-x5-","background判断消息类型为",e.type);console.log("[消息]","-x6-","background向",tab_crawler,"转发图片抓取消息",e);var r=e.data;var l=[];for(var a=r.length-1;a>=0;a--){var c=get_site_domainname_from_url(r[a])+"/*";l.push(c)}console.log("[调试] 准备在background抓取图片");chrome.permissions.request({permissions:["tabs"],origins:l},function(e){if(e){console.log("用户同意该访问权限");for(var o=r.length-1;o>=0;o--){get_img_file(r[o],t.tab.id)}}else{console.log("用户拒绝该访问权限",l);notification_user(chrome.i18n.getMessage("noticeImageURLCrossDomainNotPermit"))}})}});function fnCrawler_tab_inject(e,t,o){if(null==crawler_rule){return}for(var n=crawler_rule.length-1;n>=0;n--){if("complete"==o.status&&null!=o.url.match(crawler_rule[n].url_regex)){console.log("[注入] 命中抓取选项卡,网址为"+o.url);var r="var crawl_rule = {"+'"title": "'+crawler_rule[n].title_dom_path+'",'+'"content": "'+crawler_rule[n].content_dom_path+'",'+'"time": "'+crawler_rule[n].time_dom_path+'"'+"};";chrome.tabs.insertCSS(e,{file:"css/bootstrap.min.css"},function(e){console.log("[注入] bootstrap.min.css注入完成：",e)});chrome.tabs.insertCSS(e,{file:"css/repost.css"},function(e){console.log("[注入] repost.css注入完成：",e)});chrome.tabs.executeScript(e,{file:"js/jquery.min.js"},function(e){console.log("[注入] jquery.min.js注入完成：",e)});chrome.tabs.executeScript(e,{file:"js/bootstrap.min.js"},function(e){console.log("[注入] bootstrap.min.js注入完成：",e)});chrome.tabs.executeScript(e,{code:r},function(e){console.log("[注入] 配置变量code注入完成",r)});chrome.tabs.executeScript(e,{file:"js/crawler.js"},function(e){console.log("[注入] crawler.js注入完成：",e)})}}}function fnTarget_tab_inject(e,t,o){if(null==target_rule){return}console.log("[调试] changeInfo,",t,"tab,",o);if("complete"==o.status&&null!=o.url.match(target_rule.url_new+"#fromassistent")){console.log("[注入] 命中目标选项卡,网址为"+o.url);var n="var tgt_rule = {"+'"title": "'+target_rule.title_dom_path+'",'+'"content": "'+target_rule.content_dom_path+'",'+'"label": "'+target_rule.title_label_dom_path+'"'+"};";chrome.tabs.insertCSS(e,{file:"css/bootstrap.min.css"},function(e){console.log("[注入] 目标页面bootstrap.min.css注入完成：",e)});chrome.tabs.executeScript(e,{file:"js/jquery.min.js"},function(e){console.log("[注入] 目标页面jquery.min.js注入完成：",e)});chrome.tabs.executeScript(e,{file:"js/bootstrap.min.js"},function(e){console.log("[注入] 目标页面bootstrap.min.js注入完成：",e)});chrome.tabs.executeScript(e,{code:n},function(e){console.log("[注入] 配置变量code注入完成",n)});chrome.tabs.executeScript(e,{file:"js/inject.js"},function(e){console.log("[注入] 目标页面inject.js注入完成：",e)})}}chrome.tabs.onUpdated.addListener(fnCrawler_tab_inject);chrome.tabs.onUpdated.addListener(fnTarget_tab_inject);